<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sequence Diagram Editor</title>

    <!-- VueJS base packages and styling. -->
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">

    <!-- JS Sequence Diagrams: https://github.com/bramp/js-sequence-diagrams -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.10.2/underscore-min.min.js"></script>
    <script src="./js/webfont.js"></script>
    <script src="./js/snap.svg-min.js"></script>
    <script src="./js/sequence-diagram-min.js"></script>

    <!-- Ace text editor: https://ace.c9.io/ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js" integrity="sha512-GoORoNnxst42zE3rYPj4bNBm0Q6ZRXKNH2D9nEmNvVF/z24ywVnijAWVi/09iBiVDQVf3UlZHpzhAJIdd9BXqw==" crossorigin="anonymous"></script>

    <style>
      [v-cloak] {
        display: none;
      }

      #editor {
        width: 100%;
        height: 100%;
      }

      .round-box {
        border-radius: 6px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .button-container {
        padding-top: 10px;
        text-align: center;
      }

      .scrolling-wrapper-flexbox {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        
        margin: auto;
        width: 100%;
      }
      .flexbox-card {
        flex: 0 0 auto;

        display: block;
        margin: auto !important;
      }
    </style>
  </head>  
  <body>
    <section id="app" class="section">
      <div class="columns is-centered">
        <div class="column is-half">
          <div id="editor" class="round-box"></div>
          <div class="button-container">
            <b-button @click="savePng">Save As PNG</b-button>
            <b-button @click="saveText">Save Text</b-button>
            <b-button @click="loadText">Load Text</b-button>
          </div>
        </div>
      </div>

      <!-- SVG display. Avoid column layout to support horizontal scrolling. -->
      <div class="scrolling-wrapper-flexbox round-box">
        <div id="diagram-display" class="flexbox-card" ref="diagram-display"></div>
      </div>
    </section>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <strong>Bulma</strong> by <a href="https://jgthms.com">Jeremy Thomas</a>. The source code is licensed
          <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. The website content
          is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
        </p>
      </div>
    </footer>

    <script>
      var app = new Vue({
        el: "#app",

        data: {
          
        },

        mounted: function() {
          let editor = ace.edit("editor", {
            minLines: 20,
            maxLines: 20,
            showPrintMargin: false,
          });
          editor.session.on('change', _.debounce(this.refreshDiagram, 100));

          // Set initial focus.
          editor.focus();

          // Allow access from the rest of the component.
          Vue.prototype.$editor = editor;
        },

        methods: {
          refreshDiagram: function() {
            try {
              let diagram = Diagram.parse(this.$editor.getValue());

              this.$editor.session.clearAnnotations();

              // Clear the old diagram.
              this.$refs["diagram-display"].html = "";
              // For some reason we also need to clear this to trigger
              // a DOM update. Without it, the old diagram won't clear.
              this.$refs["diagram-display"].innerText = "";

              const options = {
                theme: 'simple',
                scale: 1,
              };
              diagram.drawSVG("diagram-display", options);
            } catch(err) {
              let annotation = {
                type: "error",
                column: 0,
                row: 0,
                text: err.message
              };

              if (err instanceof Diagram.ParseError) {
                annotation.row = err.loc.first_line - 1;
                annotation.column = err.loc.first_line;
              }

              this.$editor.session.setAnnotations([annotation]);
            }
          },

          savePng: function() {
            // TODO:
          },
          saveText: function() {
            // TODO:
          },
          loadText: function() {
            // TODO:
          },
        },
      });
    </script>
  </body>
</html>
